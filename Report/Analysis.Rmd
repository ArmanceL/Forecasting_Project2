---
title: "Analysis"
output: html_document
date: '2022-05-03'
---

```{r, echo = FALSE, message = FALSE}
source("../scripts/setup.R")
```


### For this first analysis, we are going to focus on the dataset Beef_data

We want to know if we can forecast the global price of beef just with the historical data.
### Plotting the data Global Price of beef in the world
```{r}
Beef_data.tsibble %>% autoplot(Global_price_of_beef)+geom_line()
```

```{r}
p <- ggplot(Beef_data.tsibble, aes(x=DATE, y=Global_price_of_beef)) +
  geom_line( color="steelblue") + 
  geom_point() +
  xlab("") +
  scale_y_continuous()

p
```



## Decomposition of every 5 years
```{r}
Beef.90_95 <- filter(Beef_data, DATE >= "1990-01-01", DATE <= "1995-01-01")
Beef.90_95 <- as_tsibble(Beef.90_95)
p1 <- Beef.90_95%>%
  autoplot(Global_price_of_beef)

Beef.95_00 <- filter(Beef_data, DATE >= "1995-01-01", DATE <= "2000-01-01")
Beef.95_00<- as_tsibble(Beef.95_00)
p2 <- Beef.95_00%>%
  autoplot(Global_price_of_beef)

Beef.00_05 <- filter(Beef_data, DATE >= "2000-01-01", DATE <= "2005-01-01")
Beef.00_05<- as_tsibble(Beef.00_05)
p3 <- Beef.00_05%>%
  autoplot(Global_price_of_beef)

Beef.05_10 <- filter(Beef_data, DATE >= "2005-01-01", DATE <= "2010-01-01")
Beef.05_10<- as_tsibble(Beef.05_10)
p4 <- Beef.05_10%>%
  autoplot(Global_price_of_beef)

Beef.10_15 <- filter(Beef_data, DATE >= "2010-01-01", DATE <= "2015-01-01")
Beef.10_15<- as_tsibble(Beef.10_15)
p5 <- Beef.10_15%>%
  autoplot(Global_price_of_beef)

Beef.15_21 <- filter(Beef_data, DATE >= "2015-01-01", DATE <= "2021-12-01")
Beef.15_21<- as_tsibble(Beef.15_21)
p6 <- Beef.15_21%>%
  autoplot(Global_price_of_beef)
```

```{r}
plot_grid(p1, p2, p3, p4, p5, p6)
```
No real pattern apparent...No cyclic or seasonal after decomposition


# Decompostion does not work 
```{r}
#Beef.15_21 %>% decompose(type="multiplicative") %>%
  #autoplot() + xlab("Year") +
  #ggtitle("Classical multiplicative decomposition")
# time series has no or less than 2 periods

```

```{r}
#beef_Comp <- decompose(Beef_data.tsibble)
```

With this non apparent pattern, we can try to apply the difference to the time serie. Making it non-sationnary could be helpful and apply an ARIMA model

----------------------------------------

### Apply the basics model (NAIVE, SNAIVE, MEAN)

## NAIVE model

```{r}
naive_mod <- naive(Beef_data.tsibble, h = 6)
summary(naive_mod)
```

```{r}
naive_fit <- naive(Beef_data.tsibble, h=12)
naive_fit$mean
```

# Plot the NAIVE model
```{r}
beef.fit.NAIVE <- Beef_data.tsibble %>% model(NAIVE(Global_price_of_beef))
augment(beef.fit.NAIVE) %>% ggplot(aes(x = DATE)) + geom_line(aes(y = Global_price_of_beef, colour = "Data")) +
geom_line(aes(y = .fitted, colour = "Fitted")) + scale_color_manual(values = c(Data = "blue", Fitted = "orange") ) + guides(colour = guide_legend(title = "Series"))
```


# SNAIVE model
```{r}
snaive_fit <- snaive(Beef_data.tsibble, h=12)
snaive_fit$mean
```
# Plot the SNAIVE model
```{r}
beef.fit.SNAIVE <- Beef_data.tsibble %>% model(SNAIVE(Global_price_of_beef))
augment(beef.fit.SNAIVE) %>% ggplot(aes(x = DATE)) + geom_line(aes(y = Global_price_of_beef, colour = "Data")) +
geom_line(aes(y = .fitted, colour = "Fitted")) + scale_color_manual(values = c(Data = "blue", Fitted = "orange") ) + guides(colour = guide_legend(title = "Series"))

```

# MEAN model

```{r}
mean_model <- Beef_data.tsibble %>% model(MEAN(Global_price_of_beef)) 
forecast_mean_model <- mean_model %>% forecast(h = 3) 
forecast_mean_model
```


```{r}
Beef_data.tsibble <- Beef_data.tsibble %>%
  mutate(`5-MA` = slider::slide_dbl(Global_price_of_beef, mean,
                                    .before = 2, .after = 2, .complete = TRUE))
Beef_data.tsibble
```

```{r}
Beef_data.tsibble <- Beef_data.tsibble %>%
  mutate(`9-MA` = slider::slide_dbl(Global_price_of_beef, mean,
                                    .before = 2, .after = 2, .complete = TRUE))
Beef_data.tsibble
```

```{r}
Beef_data.tsibble %>%
autoplot(Global_price_of_beef) +
autolayer(Beef_data.tsibble, `5-MA`, color='red', size = 1.2) +
xlab("DATE") + ylab("Global_price_of_beef") + ggtitle("Global_price_of_beef")
```

```{r}
Beef_data.tsibble %>%
autoplot(Global_price_of_beef) +
autolayer(Beef_data.tsibble, `9-MA`, color='red', size = 1) +
xlab("DATE") + ylab("Global_price_of_beef") + ggtitle("Global_price_of_beef")
```



```{r}
mean_model <- Beef_data.tsibble%>% model(MEAN(Global_price_of_beef))
forecast_mean_model <- mean_model %>% forecast(h = 3) 
forecast_mean_model
```

```{r}
mean_model %>% forecast(h = 6) %>% autoplot(Beef_data.tsibble)
```


```{r}
mean_model <- Beef_data.tsibble %>% model( Mean = MEAN(Global_price_of_beef),
Naive = NAIVE(Global_price_of_beef),
S_Naive = SNAIVE(Global_price_of_beef))
forecast_mean_model <- mean_model %>% forecast(h = 36)
forecast_mean_model %>% autoplot(Beef_data.tsibble, level = NULL) +
guides(colour=guide_legend(title = "Forecast"))

```

# The accuracy 
```{r}
mean_model %>% accuracy
beef.fit.NAIVE %>% accuracy()
beef.fit.SNAIVE %>% accuracy()
```



```{r}
fit <- Beef_data.tsibble %>%
model(ETS(Global_price_of_beef ~ error("A") + trend("N", alpha = 0.1) + season("N")))
fit %>% forecast(h = 36) %>% autoplot(Beef_data.tsibble, level = 0) + theme(legend.position = "none")
```


```{r}
fit <- Beef_data.tsibble %>%
model(ETS(Global_price_of_beef ~ error("A") + trend("N", alpha = 0.5) + season("N")))
fit %>% forecast(h = 36) %>% autoplot(Beef_data.tsibble, level = 0) + theme(legend.position = "none")
```

```{r}
fit <- Beef_data.tsibble %>%
model(ETS(Global_price_of_beef ~ error("A") + trend("N") + season("N"), opt_crit = "mse"))
coefficients(fit)
```
According to the fit, we should set alpha = 1, which is exactly equal to the naive model, so the latest observation, these attempt in ETS, NAIVE or MEAN look unrelevant...

```{r}
fit.ann <- Beef_data.tsibble %>%
model(ETS(Global_price_of_beef ~ error("A") + trend("N", alpha = 0.99) + season("N")))
fit.ann %>% forecast(h = 36) %>% autoplot(Beef_data.tsibble, level = 0) + theme(legend.position = "none")
fit.ann%>%accuracy()
```

```{r}
fit.ann %>% forecast(h = 24) %>% autoplot(Beef_data.tsibble) +
geom_line(aes(y = .fitted, colour = "Fitted"), data = augment(fit.ann)) +
ylab("Global_price_of_beef") + xlab("DATE")
```


```{r}
fit.A.A.N <- Beef_data.tsibble %>%
model(ETS(Global_price_of_beef ~ error("A") + trend("A") + season("N")))
fit.A.A.N %>% forecast(h = 36) %>% autoplot(Beef_data.tsibble, level = 0) + theme(legend.position = "none")
fit.A.A.N%>%accuracy()
```

```{r}
fit.ann %>% forecast(h = 24) %>% autoplot(Beef_data.tsibble, level = 0) + 
geom_line(aes(y = .fitted, colour = "Fitted"),
data=augment(fit), size = 0.5)
```

```{r}
report(fit.A.A.N)
```

```{r}
fitAAN.<- Beef_data.tsibble %>%
model(ETS(Global_price_of_beef ~ error("A") + trend("A",alpha = 0.9, beta = 0.01) + season("N")))
fitAAN. %>% forecast(h = 36) %>% autoplot(Beef_data.tsibble, level = 0) + theme(legend.position = "none")
fitAAN.%>%accuracy()
```

```{r}
fitAAA<- Beef_data.tsibble%>% model(
additive = ETS(Global_price_of_beef ~ error("A") + trend("A") + season("A")))
fc <- fitAAA %>% forecast(h = "1 years")
fc %>% autoplot(Beef_data.tsibble, level = NULL)
fitAAA%>%accuracy()
```


```{r}
fit.AAM <- Beef_data.tsibble %>% model(
additive = ETS(Global_price_of_beef ~ error("A") + trend("A") + season("A")), multiplicative = ETS(Global_price_of_beef ~ error("M") + trend("A") + season("M")))
fc <- fit.AAM %>% forecast(h = "1 years")
fc %>% autoplot(Beef_data.tsibble, level = NULL, size = c(1.2)) + xlab("DATE")
fit.AAM%>% accuracy()
```

```{r}
fitAAA %>% forecast(h = 24) %>% autoplot(Beef_data.tsibble) +
geom_line(aes(y = .fitted, colour = "Fitted"), data = augment(fitAAA)) +
ylab("Global_price_of_beef") + xlab("DATE")
```

Best accuracy result is for ETS(AAA)


### Time series Cross Validation

```{r}
beef.data_tr <- Beef_data.tsibble %>% slice(1:(n()-1)) %>% stretch_tsibble(.init = 3, .step = 1)
head(beef.data_tr)
```

```{r}
fc <- beef.data_tr %>% model(NAIVE(Global_price_of_beef)) %>% forecast(h = 1)
fc
```

```{r}
fc %>% accuracy(Beef_data.tsibble)
```

```{r}
fitAAA %>% accuracy()
```

The ETS model (A,A,A) is not significantly improving the most basic forecast NAIVE model



- All of theses analysis demonstrate that it is extremely hard to get a good accurate forecast.

-----------------------------------------------------------------------------------------------------------------


#### Non-Stationnary forecast analysis 

# Differencing the data
```{r}
# Apply the first difference to the dataset beef_data.tsibble
Beef_data.tsibble %>% autoplot(log(Global_price_of_beef))
Beef.diff <- Beef_data.tsibble %>% autoplot(log(Global_price_of_beef) %>% difference())
Beef.diff
```
The data transformations of differencing make this time series stationary


```{r}
fit.ARIMA <- Beef_data.tsibble %>%
  model(ARIMA(Global_price_of_beef))
report(fit.ARIMA)
```

```{r}
fit.ARIMA %>% forecast(h=12) %>%
  autoplot(Beef_data.tsibble)
```

```{r}
fit.ARIMA %>% accuracy()
```
Better accuracy !

```{r}
# acf(Beef_data.tsibble, na.action = na.pass)
```

```{r}
Beef_data.tsibble %>%
  ACF(Global_price_of_beef) %>%
  autoplot()
```



```{r}
Beef_data.tsibble %>%
  gg_tsdisplay(difference(Global_price_of_beef), plot_type='partial')
```

-------------------------------------------------------------------------------------


```{r}
#Beef_data.tsibble %>%
  #forecast(h=5) %>%
  #filter(.model=='search') %>%
  #autoplot(Global_price_of_beef)
```



```{r}
#se_model <- ses(Beef_data.tsibble, h = 12)
#summary(se_model)
```

--------------------------------------------
### Forecast a Time Series Regression Model
--------------------------------------------

```{r}
TOTAL <- merge(Beef_data.tsibble, Beef_US_price.tsibble, by = 'DATE')
TOTAL$US_beef_price <- TOTAL$US_beef_price*100
```

```{r}
ggplot(TOTAL, aes(x=DATE)) + 
  geom_line(aes(y = US_beef_price), color = "darkred") + 
  geom_line(aes(y = Global_price_of_beef), color="steelblue")

plot(TOTAL)

```


```{r}
#Beef_US_Comp <- decompose(Beef_US_price.tsibble)

#time series has no or less than 2 periods
```


------------------------------------------------


```{r}
cor(TOTAL$Global_price_of_beef,TOTAL$US_beef_price)
```


```{r}
mod1 <- lm(Global_price_of_beef~ US_beef_price, data = TOTAL)
summary(mod1)
plot(mod1)
```
Now that we know that the Global price of beef is significantly impacted by the US beef price, we are going to focus on the US_beef production


```{r}
ggplot(TOTAL,
aes(x = Global_price_of_beef,
y = US_beef_price)) + geom_point()
```

```{r}
Tab2 <- merge(Beef_price_annual.tsibble, Beef_US_production.tsibble, by = 'DATE')
```


```{r}
cor(Tab2)
```

```{r}
ggplot(Tab2,
aes(x = US_beef_production,
y = Annual_beef_price)) + geom_point()
```

```{r}
cor(Tab2$Annual_beef_price,Tab2$US_beef_production)
```


```{r}
mod2 <- lm(Annual_beef_price ~ US_beef_production,data = Tab2)
summary(mod2)
```
```{r}
mod3 <- lm(Annual_beef_price ~ .,data = Tab2)
summary(mod3)
```


```{r}
Tab2.ts <- as_tsibble(Tab2, index = DATE)
Tab2.ts %>% model(TSLM(Annual_beef_price ~ US_beef_production )) %>%
report()
```
Does not show a strong relationship between the production and the price in US...

## Take a look at the correlation between the corn price in US and the US beef price. 
```{r}
tab3 <- merge(Beef_US_price.tsibble, Corn_price_US.tsibble, by = 'DATE')
tab3$US_beef_price <- tab3$US_beef_price *100
```

```{r}
cor(tab3$US_beef_price, tab3$US_corn_price)
```

```{r}
ggplot(tab3,
aes(x = US_corn_price,
y = US_beef_price)) + geom_point()
```

```{r}
mod4 <- lm(US_beef_price ~ US_corn_price, data = tab3)
summary(mod4)
```

```{r}
plot(mod4)
```


```{r}
tab3.ts <- as_tsibble(tab3) %>% fill_gaps()
fitTSLM <-  tab3.ts %>% model(TSLM(US_beef_price ~ US_corn_price)) %>%
report()
```

```{r}
tab3.ts %>% GGally::ggpairs(columns = 2:3)
```

```{r}
augment(fitTSLM) %>%
ggplot(aes(x = DATE)) +
geom_line(aes(y = US_beef_price, colour = "Data")) +
geom_line(aes(y = .fitted, colour = "Fitted")) + xlab("Year") + ylab(NULL) + guides(colour = guide_legend(title=NULL))
```

```{r}
augment(fitTSLM) %>%
ggplot(aes(x = US_beef_price, y = .fitted)) + geom_point() + ylab("Fitted (predicted values)") + xlab("Data (actual values)") + geom_abline(intercept = 0, slope = 1)
```

```{r}
tab3 %>%
  as.data.frame() %>%
  ggplot(aes(x=US_corn_price, y=US_beef_price)) +
    ylab("US_beef_price") +
    xlab("US_corn_price") +
    geom_point() +
    geom_smooth(method="lm", se=FALSE)
```


```{r}
fitTSLM %>% gg_tsresiduals()
```

This one does not work
```{r}
checkresiduals(mod4)
```

```{r}
CV(mod4)
```



## Cannot make the forecast in the end...
```{r}

fit_beef <- tab3.ts %>% model(TSLM(US_beef_price ~ US_corn_price))
fc <- forecast(mod4)

fc %>% autoplot(US_beef_price) 

```

```{r}
fit.US <- tslm(US_beef_price ~ US_corn_price, data = tab3.ts)
h <- 4
fcast.ave <- forecast(fit.cons,
  newdata = data.frame(
    Income = rep(mean(uschange[,"Income"]), h)))
fcast.up <- forecast(fit.cons,
  newdata = data.frame(Income = rep(5, h)))
autoplot(uschange[, "Consumption"]) +
  ylab("% change in US consumption") +
  autolayer(fcast.ave, series = "Average increase",
    PI = TRUE) +
  autolayer(fcast.up, series = "Extreme increase",
    PI = TRUE) +
  guides(colour = guide_legend(title = "Scenario"))
```

```{r}
tab3.ts
```

```{r}

```

```{r}

```


```{r}

```

```{r}

```


